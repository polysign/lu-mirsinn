rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /devices/{deviceId} {
      allow get: if true;
      allow list: if false;

      allow create: if request.resource.data.deviceId == deviceId
        && request.resource.data.deviceId is string
        && request.resource.data.deviceId.size() > 0;

      allow update: if request.resource.data.deviceId == deviceId
        && request.resource.data.deviceId is string
        && resource.data.deviceId == deviceId;

      allow delete: if false;
    }

    match /shortcodes/{code} {
      allow get: if true;
      allow list: if false;
      allow create, update: if request.resource.data.deviceId is string
        && request.resource.data.deviceId.size() > 0
        && (resource == null || resource.data.deviceId == request.resource.data.deviceId);
      allow delete: if false;
    }

    match /questions/{questionId} {
      allow get, list: if true;
      allow create, update, delete: if false;

      match /answers/{deviceId} {
        allow get: if resource == null || resource.data.deviceId == deviceId;
        allow list: if false;

        allow create: if request.resource.data.deviceId == deviceId
          && request.resource.data.deviceId is string
          && request.resource.data.optionId is string
          && request.resource.data.language is string
          && request.resource.data.answeredAt is string;

        allow update: if resource.data.deviceId == deviceId
          && request.resource.data.deviceId == deviceId
          && request.resource.data.optionId is string
          && request.resource.data.language is string
          && request.resource.data.answeredAt is string;

        allow delete: if false;
      }
    }
  }
}
